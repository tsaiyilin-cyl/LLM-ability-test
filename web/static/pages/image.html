<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å›¾ç‰‡åˆ†ç±»æµ‹è¯• - LLM èƒ½åŠ›æµ‹è¯•å¹³å°</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>ğŸ–¼ï¸ å›¾ç‰‡åˆ†ç±»æµ‹è¯•</h1>
            <p>æµ‹è¯•æ¨¡å‹çš„è§†è§‰ç†è§£ä¸åˆ†ç±»èƒ½åŠ›</p>
            <a href="/static/index.html" class="back-link">â† è¿”å›é¦–é¡µ</a>
        </header>

        <!-- API é…ç½® -->
        <section class="card">
            <div class="collapsible-header" onclick="toggleSection('configBody')">
                <h3>âš™ï¸ API é…ç½®</h3>
                <span class="toggle-icon" id="configIcon">â–¼</span>
            </div>
            <div class="collapsible-body" id="configBody">
                <div class="form-grid">
                    <div class="form-field">
                        <label>API Base URL</label>
                        <input type="text" id="apiBaseUrl" placeholder="https://api.openai.com">
                    </div>
                    <div class="form-field">
                        <label>API Key</label>
                        <div class="input-with-toggle">
                            <input type="password" id="apiKey" placeholder="sk-xxxxxxxx">
                            <button class="toggle-visibility" onclick="toggleKeyVisibility()">ğŸ‘ï¸</button>
                        </div>
                    </div>
                </div>
                <div class="btn-group mt-2">
                    <button class="btn btn-primary btn-sm" onclick="App.saveApiConfig()">ğŸ’¾ ä¿å­˜</button>
                    <button class="btn btn-secondary btn-sm" onclick="App.testConnection()">ğŸ”— æµ‹è¯•è¿æ¥</button>
                    <button class="btn btn-secondary btn-sm" id="fetchModelsBtn" onclick="App.fetchModelsFromAPI()">ğŸ”„ è·å–æ¨¡å‹åˆ—è¡¨</button>
                </div>
                <div class="status info mt-1" id="apiStatus">âšª ç‚¹å‡»æµ‹è¯•è¿æ¥</div>
            </div>
        </section>

        <!-- æ§åˆ¶é¢æ¿ -->
        <div class="form-grid">
            <div class="card">
                <div class="collapsible-header" onclick="toggleSection('modelBody')">
                    <div>
                        <h3>ğŸ¤– é€‰æ‹©æ¨¡å‹</h3>
                        <span class="model-display" id="modelDisplay">æœªé€‰æ‹©</span>
                    </div>
                    <span class="toggle-icon open" id="modelIcon">â–¼</span>
                </div>
                <div class="collapsible-body open" id="modelBody">
                    <div class="model-selector">
                        <input type="text" id="modelSearchInput" class="model-search-input" placeholder="ğŸ” æœç´¢æ¨¡å‹...">
                        <select id="modelSelect" size="8" class="model-select">
                            <!-- æ¨¡å‹åˆ—è¡¨å°†é€šè¿‡ JavaScript åŠ¨æ€åŠ è½½ -->
                        </select>
                        <span class="hint">
                            è¯·åœ¨ API é…ç½®ä¸­ç‚¹å‡»"è·å–æ¨¡å‹åˆ—è¡¨"æŒ‰é’®è·å–æ¨¡å‹ï¼Œç„¶ååœ¨æœç´¢æ¡†ä¸­è¾“å…¥å…³é”®è¯å¿«é€ŸæŸ¥æ‰¾
                        </span>
                    </div>
                </div>
            </div>

            <div class="card">
                <h3 class="mb-1">æµ‹è¯•è¯­è¨€</h3>
                <select id="langSelect">
                    <option value="zh">ä¸­æ–‡</option>
                    <option value="en">English</option>
                    <option value="all">ğŸŒ ä¸­è‹±å…¨é€‰</option>
                </select>
            </div>

            <div class="card">
                <h3 class="mb-1">æ‰§è¡Œæµ‹è¯•</h3>
                <button class="btn btn-primary btn-block" id="runTestBtn" onclick="App.runTests()">
                    ğŸš€ è¿è¡Œé€‰ä¸­æµ‹è¯•
                </button>
                <div class="checkbox-wrapper mt-1">
                    <input type="checkbox" id="selectAll" onchange="App.toggleSelectAll()">
                    <label for="selectAll" style="color: var(--text-secondary); font-size: 0.875rem;">å…¨é€‰æ‰€æœ‰ç”¨ä¾‹</label>
                </div>
                <div class="checkbox-wrapper mt-1">
                    <input type="checkbox" id="consistencyTest" checked>
                    <label for="consistencyTest" style="color: var(--text-secondary); font-size: 0.875rem;">
                        ğŸ”„ å¯ç”¨æ¨ç†ä¸€è‡´æ€§æµ‹è¯•
                    </label>
                </div>
                <div class="form-field mt-1" id="repeatTimesField" style="display: none;">
                    <label style="font-size: 0.875rem; color: var(--text-secondary);">é‡å¤è¯¢é—®æ¬¡æ•°</label>
                    <input type="number" id="repeatTimes" min="2" max="10" value="3" 
                           style="width: 100px; padding: 0.25rem; font-size: 0.875rem; border: 1px solid var(--border-color); border-radius: 4px;">
                    <span style="font-size: 0.75rem; color: var(--text-muted); margin-left: 0.5rem;">æ¬¡ï¼ˆ2-10ï¼‰</span>
                </div>
            </div>
        </div>

        <!-- æç¤ºè¯é…ç½® -->
        <section class="card">
            <div class="collapsible-header" onclick="toggleSection('promptBody')">
                <h3>ğŸ“ æç¤ºè¯é…ç½®</h3>
                <span class="toggle-icon" id="promptIcon">â–¼</span>
            </div>
            <div class="collapsible-body open" id="promptBody">
                <div class="form-grid">
                    <div class="form-field">
                        <label>System Prompt <span style="font-size: 0.7rem; color: var(--accent-primary);">(ç³»ç»Ÿæç¤ºè¯)</span></label>
                        <textarea id="sysPrompt" placeholder="è¾“å…¥ç³»ç»Ÿæç¤ºè¯..."></textarea>
                        <span class="hint">å®šä¹‰ AI åŠ©æ‰‹çš„è§’è‰²å’Œè¡Œä¸º</span>
                    </div>
                    <div class="form-field">
                        <label>User Prompt <span style="font-size: 0.7rem; color: var(--accent-primary);">(ç”¨æˆ·æç¤ºè¯æ¨¡æ¿)</span></label>
                        <textarea id="userPrompt" placeholder="è¾“å…¥ç”¨æˆ·æç¤ºè¯æ¨¡æ¿..."></textarea>
                        <span class="hint">ä½¿ç”¨ <code>{question}</code> ä½œä¸ºå›¾ç‰‡åç§°å ä½ç¬¦</span>
                    </div>
                </div>
                <div class="btn-group mt-2">
                    <button class="btn btn-secondary btn-sm" onclick="App.resetPrompts()">ğŸ”„ é‡ç½®ä¸ºé»˜è®¤</button>
                    <button class="btn btn-secondary btn-sm" onclick="App.savePrompts()">ğŸ’¾ ä¿å­˜æç¤ºè¯</button>
                </div>
            </div>
        </section>

        <!-- å›¾ç‰‡ä¸Šä¼ ï¼ˆä¿ç•™å•å›¾æµ‹è¯•åŠŸèƒ½ï¼‰ -->
        <section class="card">
            <h3 class="mb-1">ğŸ“¤ ä¸Šä¼ æµ‹è¯•å›¾ç‰‡ï¼ˆå•å›¾æµ‹è¯•ï¼‰</h3>
            <div class="image-upload-zone" id="uploadZone" onclick="document.getElementById('imageInput').click()">
                <input type="file" id="imageInput" accept="image/*" class="hidden-input" onchange="handleImageUpload(event)">
                <p class="upload-text">ç‚¹å‡»æˆ–æ‹–æ‹½å›¾ç‰‡åˆ°æ­¤å¤„ä¸Šä¼ </p>
                <p class="upload-text-small">æ”¯æŒ JPG, PNG, GIF, WebP</p>
            </div>
            <img id="imagePreview" class="image-preview hidden">
            <div class="btn-group mt-2">
                <button class="btn btn-primary" id="classifyBtn" onclick="classifyImage()" disabled>ğŸ” å¼€å§‹åˆ†ç±»</button>
                <button class="btn btn-secondary" onclick="clearImage()">ğŸ—‘ï¸ æ¸…é™¤å›¾ç‰‡</button>
            </div>
        </section>

        <!-- é¢„è®¾æµ‹è¯•å›¾ç‰‡ -->
        <section class="card">
            <div class="card-header">
                <h3 class="mb-0">ğŸ–¼ï¸ é¢„è®¾æµ‹è¯•å›¾ç‰‡</h3>
                <button class="btn btn-secondary btn-sm" onclick="App.clearAllData()">ğŸ—‘ï¸ æ¸…é™¤å†å²æ•°æ®</button>
            </div>
            <p class="preset-hint">å‹¾é€‰å›¾ç‰‡è¿›è¡Œæ‰¹é‡æµ‹è¯•ï¼Œæˆ–ç‚¹å‡»å›¾ç‰‡è¿›è¡Œå•å›¾æµ‹è¯•</p>
            <div class="test-grid" id="testCasesGrid">
                <!-- å›¾ç‰‡åˆ—è¡¨å°†åœ¨è¿™é‡ŒåŠ è½½ -->
            </div>
        </section>

        <!-- æµ‹è¯•ç»“æœ -->
        <section class="card hidden" id="resultsSection">
            <div class="card-header">
                <h3>ğŸ“Š æµ‹è¯•ç»“æœ</h3>
                <div class="btn-group">
                    <button class="btn btn-primary btn-sm" onclick="Components.generateEvaluationReport()">ğŸ“‹ ç”Ÿæˆè¯„ä¼°æŠ¥å‘Š</button>
                    <button class="btn btn-secondary btn-sm" onclick="App.clearResults()">æ¸…ç©ºç»“æœ</button>
                </div>
            </div>
            <div class="stats-bar">
                <div class="stat-item">
                    <div class="stat-value" id="totalTests">0</div>
                    <div class="stat-label">æ€»æµ‹è¯•æ•°</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="passedCount">0</div>
                    <div class="stat-label">æˆåŠŸæµ‹è¯•</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="avgTime">0s</div>
                    <div class="stat-label">å¹³å‡å“åº”</div>
                </div>
            </div>
            <div id="resultsContainer"></div>
        </section>
    </div>

    <script src="/static/js/api.js"></script>
    <script src="/static/js/components.js"></script>
    <script src="/static/js/app.js"></script>
    <script>
        // æŠ˜å é¢æ¿
        // æŠ˜å é¢æ¿
        function toggleSection(id) {
            const body = document.getElementById(id);
            const iconId = id.replace('Body', 'Icon');
            const icon = document.getElementById(iconId);
            body.classList.toggle('open');
            if (icon) icon.classList.toggle('open');
        }

        // å¯†ç å¯è§æ€§
        function toggleKeyVisibility() {
            const input = document.getElementById('apiKey');
            input.type = input.type === 'password' ? 'text' : 'password';
        }

        // å›¾ç‰‡ä¸Šä¼ ç›¸å…³å‡½æ•°ï¼ˆä¿ç•™å•å›¾æµ‹è¯•åŠŸèƒ½ï¼‰
        let currentImage = null;

        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    currentImage = e.target.result;
                    document.getElementById('imagePreview').src = currentImage;
                    document.getElementById('imagePreview').classList.remove('hidden');
                    document.getElementById('classifyBtn').disabled = false;
                };
                reader.readAsDataURL(file);
            }
        }

        // æ‹–æ‹½ä¸Šä¼ 
        const uploadZone = document.getElementById('uploadZone');
        if (uploadZone) {
            uploadZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadZone.classList.add('dragover');
            });
            uploadZone.addEventListener('dragleave', () => {
                uploadZone.classList.remove('dragover');
            });
            uploadZone.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadZone.classList.remove('dragover');
                const file = e.dataTransfer.files[0];
                if (file && file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = function(ev) {
                        currentImage = ev.target.result;
                        document.getElementById('imagePreview').src = currentImage;
                        document.getElementById('imagePreview').classList.remove('hidden');
                        document.getElementById('classifyBtn').disabled = true;
                    };
                    reader.readAsDataURL(file);
                }
            });
        }

        function clearImage() {
            currentImage = null;
            document.getElementById('imagePreview').classList.add('hidden');
            document.getElementById('imageInput').value = '';
            document.getElementById('classifyBtn').disabled = true;
        }

        async function classifyImage() {
            if (!currentImage) return;
            
            const btn = document.getElementById('classifyBtn');
            btn.disabled = true;
            btn.textContent = 'â³ åˆ†ç±»ä¸­...';
            
            const resultsSection = document.getElementById('resultsSection');
            resultsSection.classList.remove('hidden');
            const container = document.getElementById('resultsContainer');
            
            const lang = document.getElementById('langSelect')?.value || 'zh';
            const loading = Components.createLoading('classify', lang === 'zh' ? 'æ­£åœ¨åˆ†æå›¾ç‰‡...' : 'Analyzing image...');
            container.insertBefore(loading, container.firstChild);
            
            try {
                const prompts = {
                    sys_prompt: document.getElementById('sysPrompt')?.value || '',
                    user_prompt: document.getElementById('userPrompt')?.value || ''
                };
                const model = App.getSelectedModel();
                
                const result = await API.classifyImage(currentImage, model, prompts);
                
                document.getElementById('loading-classify')?.remove();
                
                if (result.success) {
                    const card = document.createElement('div');
                    card.className = 'result-card';
                    card.innerHTML = `
                        <div class="result-meta">
                            <span>ğŸ¤– ${result.model}</span>
                            <span class="badge">${lang === 'zh' ? 'ä¸­æ–‡' : 'English'}</span>
                            <span class="time">â±ï¸ ${result.response_time}s</span>
                        </div>
                        <div class="mb-2">
                            <img src="${currentImage}" class="result-image">
                        </div>
                        <div class="result-answer">
                            <h4>${lang === 'zh' ? 'åˆ†ç±»ç»“æœ' : 'Classification Result'}</h4>
                            <pre>${result.answer}</pre>
                        </div>
                    `;
                    container.insertBefore(card, container.firstChild);
                } else {
                    const errorCard = Components.createErrorCard('classify', result.error);
                    container.insertBefore(errorCard, container.firstChild);
                }
            } catch (e) {
                document.getElementById('loading-classify')?.remove();
                const errorCard = Components.createErrorCard('classify', e.message);
                container.insertBefore(errorCard, container.firstChild);
            }
            
            btn.disabled = false;
            btn.textContent = 'ğŸ” å¼€å§‹åˆ†ç±»';
        }

        // æ‰©å±• App æ¨¡å—ä»¥æ”¯æŒå›¾ç‰‡åˆ†ç±»çš„ç‰¹æ®Šæ¸²æŸ“
        const originalRenderTestCases = App.renderTestCases;
        App.renderTestCases = function() {
            const grid = document.getElementById('testCasesGrid');
            if (!grid) return;
            
            grid.innerHTML = '';
            
            // å¦‚æœæ˜¯å›¾ç‰‡åˆ†ç±»ï¼Œä½¿ç”¨ç‰¹æ®Šçš„æ¸²æŸ“æ–¹å¼
            if (this.state.currentDimension === 'image') {
                this.renderImageTestCases();
            } else {
                // å…¶ä»–ç»´åº¦ä½¿ç”¨åŸæœ‰æ–¹å¼
                originalRenderTestCases.call(this);
            }
        };

        // æ¸²æŸ“å›¾ç‰‡æµ‹è¯•ç”¨ä¾‹
        App.renderImageTestCases = async function() {
            const grid = document.getElementById('testCasesGrid');
            if (!grid) return;
            
            grid.innerHTML = '<p class="text-muted">æ­£åœ¨åŠ è½½é¢„è®¾å›¾ç‰‡...</p>';
            
            try {
                const lang = document.getElementById('langSelect')?.value || 'zh';
                const loadLang = lang === 'all' ? 'zh' : lang;
                const response = await fetch(`/api/preset-images?lang=${loadLang}`);
                const result = await response.json();
                
                if (result.success && result.images && result.images.length > 0) {
                    grid.innerHTML = '';
                    
                    // å°†å›¾ç‰‡æ•°æ®è½¬æ¢ä¸ºæµ‹è¯•ç”¨ä¾‹æ ¼å¼
                    const imageCases = {};
                    result.images.forEach(img => {
                        imageCases[img.id] = {
                            name: img.name,
                            category: img.category,
                            level: img.level,
                            type: img.type,
                            filename: img.url.split('/').pop(),
                            url: img.url
                        };
                    });
                    
                    // æ›´æ–° testCases
                    this.state.testCases = imageCases;
                    
                    // æ¸²æŸ“å›¾ç‰‡å¡ç‰‡
                    result.images.forEach(img => {
                        const isSelected = this.state.selectedCases.has(img.id);
                        const card = Components.createImageTestCard(
                            img.id,
                            img,
                            isSelected,
                            () => this.toggleCase(img.id)
                        );
                        grid.appendChild(card);
                    });
                } else {
                    grid.innerHTML = '<p class="text-muted">æš‚æ— é¢„è®¾å›¾ç‰‡</p>';
                }
            } catch (error) {
                console.error('åŠ è½½é¢„è®¾å›¾ç‰‡å¤±è´¥:', error);
                grid.innerHTML = '<p class="text-muted">åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•</p>';
            }
        };

        // æ§åˆ¶ä¸€è‡´æ€§æµ‹è¯•é‡å¤æ¬¡æ•°è¾“å…¥æ¡†çš„æ˜¾ç¤º
        function initConsistencyTestControl() {
            const consistencyCheckbox = document.getElementById('consistencyTest');
            const repeatTimesField = document.getElementById('repeatTimesField');
            
            if (consistencyCheckbox && repeatTimesField) {
                // åˆå§‹åŒ–æ˜¾ç¤ºçŠ¶æ€
                repeatTimesField.style.display = consistencyCheckbox.checked ? 'block' : 'none';
                
                // ç›‘å¬å¤é€‰æ¡†å˜åŒ–
                consistencyCheckbox.addEventListener('change', function() {
                    repeatTimesField.style.display = this.checked ? 'block' : 'none';
                });
            }
        }
        
        // åˆå§‹åŒ–
        App.init('image');
        
        // åˆå§‹åŒ–ä¸€è‡´æ€§æµ‹è¯•æ§åˆ¶
        document.addEventListener('DOMContentLoaded', initConsistencyTestControl);
        // å¦‚æœDOMå·²ç»åŠ è½½å®Œæˆï¼Œç«‹å³æ‰§è¡Œ
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initConsistencyTestControl);
        } else {
            initConsistencyTestControl();
        }
    </script>
</body>
</html>
