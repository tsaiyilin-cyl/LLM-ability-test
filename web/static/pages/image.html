<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å›¾ç‰‡åˆ†ç±»æµ‹è¯• - LLM èƒ½åŠ›æµ‹è¯•å¹³å°</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>ğŸ–¼ï¸ å›¾ç‰‡åˆ†ç±»æµ‹è¯•</h1>
            <p>æµ‹è¯•æ¨¡å‹çš„è§†è§‰ç†è§£ä¸åˆ†ç±»èƒ½åŠ›</p>
            <a href="/static/index.html" class="back-link">â† è¿”å›é¦–é¡µ</a>
        </header>

        <!-- API é…ç½® -->
        <section class="card">
            <div class="collapsible-header" onclick="toggleSection('configBody')">
                <h3>âš™ï¸ API é…ç½®</h3>
                <span class="toggle-icon" id="configIcon">â–¼</span>
            </div>
            <div class="collapsible-body" id="configBody">
                <div class="form-grid">
                    <div class="form-field">
                        <label>API Base URL</label>
                        <input type="text" id="apiBaseUrl" placeholder="https://api.openai.com">
                    </div>
                    <div class="form-field">
                        <label>API Key</label>
                        <div class="input-with-toggle">
                            <input type="password" id="apiKey" placeholder="sk-xxxxxxxx">
                            <button class="toggle-visibility" onclick="toggleKeyVisibility()">ğŸ‘ï¸</button>
                        </div>
                    </div>
                </div>
                <div class="btn-group mt-2">
                    <button class="btn btn-primary btn-sm" onclick="saveConfig()">ğŸ’¾ ä¿å­˜</button>
                    <button class="btn btn-secondary btn-sm" onclick="testConnection()">ğŸ”— æµ‹è¯•è¿æ¥</button>
                </div>
                <div class="status info mt-1" id="apiStatus">âšª ç‚¹å‡»æµ‹è¯•è¿æ¥</div>
            </div>
        </section>

        <!-- æ§åˆ¶é¢æ¿ -->
        <div class="form-grid">
            <div class="card">
                <h3 class="mb-1">é€‰æ‹©æ¨¡å‹</h3>
                <select id="modelSelect">
                    <optgroup label="å›½å†…æ¨¡å‹">
                        <option value="ernie-5.0-thinking-preview">æ–‡å¿ƒ 5.0</option>
                    </optgroup>
                    <optgroup label="è§†è§‰æ¨¡å‹">
                        <option value="o3" selected>OpenAI o3</option>
                        <option value="gpt-5.2-thinking">GPT-5.2 Thinking</option>
                        <option value="claude-3-5-sonnet-20241022">Claude 3.5 Sonnet</option>
                        <option value="gemini-3-pro-preview-thinking-*">Gemini 3 Pro Thinking</option>
                        <option value="gemini-2.5-pro-preview-thinking">Gemini 2.5 Pro Thinking</option>
                    </optgroup>
                </select>
            </div>

            <div class="card">
                <h3 class="mb-1">æµ‹è¯•è¯­è¨€</h3>
                <select id="langSelect" onchange="updatePromptsForLanguage()">
                    <option value="zh">ä¸­æ–‡</option>
                    <option value="en">English</option>
                </select>
            </div>
        </div>

        <!-- æç¤ºè¯é…ç½® -->
        <section class="card">
            <div class="collapsible-header" onclick="toggleSection('promptBody')">
                <h3>ğŸ“ æç¤ºè¯é…ç½®</h3>
                <span class="toggle-icon" id="promptIcon">â–¼</span>
            </div>
            <div class="collapsible-body open" id="promptBody">
                <div class="form-grid">
                    <div class="form-field">
                        <label>System Prompt <span style="font-size: 0.7rem; color: var(--accent-primary);">(ç³»ç»Ÿæç¤ºè¯)</span></label>
                        <textarea id="sysPrompt"></textarea>
                        <span class="hint">å®šä¹‰ AI åŠ©æ‰‹çš„è§’è‰²å’Œè¡Œä¸º</span>
                    </div>
                    <div class="form-field">
                        <label>User Prompt <span style="font-size: 0.7rem; color: var(--accent-primary);">(ç”¨æˆ·æç¤ºè¯æ¨¡æ¿)</span></label>
                        <textarea id="userPrompt"></textarea>
                        <span class="hint">è¯†åˆ«å›¾ç‰‡å†…å®¹æ—¶ä½¿ç”¨çš„æç¤ºè¯</span>
                    </div>
                </div>
                <div class="btn-group mt-2">
                    <button class="btn btn-secondary btn-sm" onclick="resetPrompts()">ğŸ”„ é‡ç½®ä¸ºé»˜è®¤</button>
                    <button class="btn btn-secondary btn-sm" onclick="savePrompts()">ğŸ’¾ ä¿å­˜æç¤ºè¯</button>
                </div>
            </div>
        </section>

        <!-- å›¾ç‰‡ä¸Šä¼  -->
        <section class="card">
            <h3 class="mb-1">ğŸ“¤ ä¸Šä¼ æµ‹è¯•å›¾ç‰‡</h3>
            <div class="image-upload-zone" id="uploadZone" onclick="document.getElementById('imageInput').click()">
                <input type="file" id="imageInput" accept="image/*" style="display: none;" onchange="handleImageUpload(event)">
                <p style="color: var(--text-muted);">ç‚¹å‡»æˆ–æ‹–æ‹½å›¾ç‰‡åˆ°æ­¤å¤„ä¸Šä¼ </p>
                <p style="font-size: 0.8rem; color: var(--text-muted); margin-top: 0.5rem;">æ”¯æŒ JPG, PNG, GIF, WebP</p>
            </div>
            <img id="imagePreview" class="image-preview hidden">
            <div class="btn-group mt-2">
                <button class="btn btn-primary" id="classifyBtn" onclick="classifyImage()" disabled>ğŸ” å¼€å§‹åˆ†ç±»</button>
                <button class="btn btn-secondary" onclick="clearImage()">ğŸ—‘ï¸ æ¸…é™¤å›¾ç‰‡</button>
            </div>
        </section>

        <!-- é¢„è®¾æµ‹è¯•å›¾ç‰‡ -->
        <section class="card">
            <h3 class="mb-1">ğŸ–¼ï¸ é¢„è®¾æµ‹è¯•å›¾ç‰‡</h3>
            <p style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 1rem;">ç‚¹å‡»å›¾ç‰‡è¿›è¡Œåˆ†ç±»æµ‹è¯•</p>
            <div class="test-grid" id="imageGrid">
                <!-- å›¾ç‰‡åˆ—è¡¨å°†åœ¨è¿™é‡ŒåŠ è½½ -->
            </div>
        </section>

        <!-- æµ‹è¯•ç»“æœ -->
        <section class="card hidden" id="resultsSection">
            <div class="card-header">
                <h3>ğŸ“Š åˆ†ç±»ç»“æœ</h3>
                <button class="btn btn-secondary btn-sm" onclick="clearResults()">æ¸…ç©ºç»“æœ</button>
            </div>
            <div id="resultsContainer"></div>
        </section>
    </div>

    <script src="/static/js/api.js"></script>
    <script src="/static/js/components.js"></script>
    <script>
        let currentImage = null;
        let testResults = [];

        // é»˜è®¤æç¤ºè¯ (ä¸­è‹±æ–‡)
        const defaultPrompts = {
            zh: {
                sys: "ä½ æ˜¯ä¸€ä¸ªå‡ºè‰²çš„å›¾ç‰‡åˆ†ç±»åŠ©æ‰‹ï¼Œå¯¹äºç”¨æˆ·è¾“å…¥çš„ä¸€å¼ å›¾ç‰‡ï¼Œå¯ä»¥è¯†åˆ«å›¾ç‰‡ä¸­çš„ä¸»ä½“ï¼Œå¹¶ä¸”è¾“å‡ºæ­£ç¡®çš„ç±»åˆ«ã€‚",
                user: "è¯†åˆ«å›¾ç‰‡ä¸­çš„å†…å®¹ï¼Œå†å›ç­”æ­£ç¡®åˆ†ç±»ä¹‹å‰å…ˆè¾“å‡ºç†ç”±ã€‚è¾“å‡ºæ ¼å¼ä¸ºï¼š\n1.reasoning\n{{æ¨ç†å†…å®¹}}\n2.answer\n{{ç±»åˆ«å}}"
            },
            en: {
                sys: "You are an excellent image classification assistant. For an image input by the user, you can identify the subject in the image and output the correct category.",
                user: "Identify the content in the image. Before answering the correct classification, output the reasoning. Format:\n1.reasoning\n{{reasoning}}\n2.answer\n{{category}}"
            }
        };

        // æŠ˜å é¢æ¿
        function toggleSection(id) {
            const body = document.getElementById(id);
            body.classList.toggle('open');
        }

        // å¯†ç å¯è§æ€§
        function toggleKeyVisibility() {
            const input = document.getElementById('apiKey');
            input.type = input.type === 'password' ? 'text' : 'password';
        }

        // ä¿å­˜é…ç½®
        function saveConfig() {
            const config = API.getConfig();
            API.saveConfig(config);
            document.getElementById('apiStatus').className = 'status success mt-1';
            document.getElementById('apiStatus').textContent = 'âœ… é…ç½®å·²ä¿å­˜';
        }

        // æµ‹è¯•è¿æ¥
        async function testConnection() {
            const status = document.getElementById('apiStatus');
            status.className = 'status info mt-1';
            status.textContent = 'ğŸ”„ æ­£åœ¨æµ‹è¯•...';
            
            try {
                const model = document.getElementById('modelSelect').value;
                const result = await API.testConnection(model);
                if (result.success) {
                    status.className = 'status success mt-1';
                    status.textContent = 'âœ… è¿æ¥æˆåŠŸï¼';
                } else {
                    status.className = 'status error mt-1';
                    status.textContent = 'âŒ ' + result.error;
                }
            } catch (e) {
                status.className = 'status error mt-1';
                status.textContent = 'âŒ ' + e.message;
            }
        }

        // æ›´æ–°æç¤ºè¯ï¼ˆæ ¹æ®è¯­è¨€ï¼‰
        function updatePromptsForLanguage() {
            const lang = document.getElementById('langSelect').value;
            const saved = localStorage.getItem(`llm_prompts_image_${lang}`);
            
            if (saved) {
                const prompts = JSON.parse(saved);
                document.getElementById('sysPrompt').value = prompts.sys_prompt || '';
                document.getElementById('userPrompt').value = prompts.user_prompt || '';
            } else {
                const defaults = defaultPrompts[lang];
                document.getElementById('sysPrompt').value = defaults.sys;
                document.getElementById('userPrompt').value = defaults.user;
            }
        }

        // ä¿å­˜æç¤ºè¯
        function savePrompts() {
            const lang = document.getElementById('langSelect').value;
            const prompts = {
                sys_prompt: document.getElementById('sysPrompt').value,
                user_prompt: document.getElementById('userPrompt').value
            };
            localStorage.setItem(`llm_prompts_image_${lang}`, JSON.stringify(prompts));
            Components.toast('âœ… æç¤ºè¯å·²ä¿å­˜ï¼');
        }

        // é‡ç½®æç¤ºè¯
        function resetPrompts() {
            const lang = document.getElementById('langSelect').value;
            const defaults = defaultPrompts[lang];
            document.getElementById('sysPrompt').value = defaults.sys;
            document.getElementById('userPrompt').value = defaults.user;
            localStorage.removeItem(`llm_prompts_image_${lang}`);
            Components.toast('ğŸ”„ å·²é‡ç½®ä¸ºé»˜è®¤æç¤ºè¯');
        }

        // å›¾ç‰‡ä¸Šä¼ 
        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    currentImage = e.target.result;
                    document.getElementById('imagePreview').src = currentImage;
                    document.getElementById('imagePreview').classList.remove('hidden');
                    document.getElementById('classifyBtn').disabled = false;
                };
                reader.readAsDataURL(file);
            }
        }

        // æ‹–æ‹½ä¸Šä¼ 
        const uploadZone = document.getElementById('uploadZone');
        uploadZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadZone.classList.add('dragover');
        });
        uploadZone.addEventListener('dragleave', () => {
            uploadZone.classList.remove('dragover');
        });
        uploadZone.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadZone.classList.remove('dragover');
            const file = e.dataTransfer.files[0];
            if (file && file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = function(ev) {
                    currentImage = ev.target.result;
                    document.getElementById('imagePreview').src = currentImage;
                    document.getElementById('imagePreview').classList.remove('hidden');
                    document.getElementById('classifyBtn').disabled = false;
                };
                reader.readAsDataURL(file);
            }
        });

        // æ¸…é™¤å›¾ç‰‡
        function clearImage() {
            currentImage = null;
            document.getElementById('imagePreview').classList.add('hidden');
            document.getElementById('imageInput').value = '';
            document.getElementById('classifyBtn').disabled = true;
        }

        // åˆ†ç±»å›¾ç‰‡
        async function classifyImage() {
            if (!currentImage) return;
            
            const btn = document.getElementById('classifyBtn');
            btn.disabled = true;
            btn.textContent = 'â³ åˆ†ç±»ä¸­...';
            
            const resultsSection = document.getElementById('resultsSection');
            resultsSection.classList.remove('hidden');
            const container = document.getElementById('resultsContainer');
            
            const lang = document.getElementById('langSelect').value;
            const loading = Components.createLoading('classify', lang === 'zh' ? 'æ­£åœ¨åˆ†æå›¾ç‰‡...' : 'Analyzing image...');
            container.insertBefore(loading, container.firstChild);
            
            try {
                const prompts = {
                    sys_prompt: document.getElementById('sysPrompt').value,
                    user_prompt: document.getElementById('userPrompt').value
                };
                const model = document.getElementById('modelSelect').value;
                
                const result = await API.classifyImage(currentImage, model, prompts);
                
                document.getElementById('loading-classify')?.remove();
                
                if (result.success) {
                    const card = document.createElement('div');
                    card.className = 'result-card';
                    card.innerHTML = `
                        <div class="result-meta">
                            <span>ğŸ¤– ${result.model}</span>
                            <span class="badge">${lang === 'zh' ? 'ä¸­æ–‡' : 'English'}</span>
                            <span class="time">â±ï¸ ${result.response_time}s</span>
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <img src="${currentImage}" style="max-width: 200px; border-radius: 8px;">
                        </div>
                        <div class="result-answer">
                            <h4>${lang === 'zh' ? 'åˆ†ç±»ç»“æœ' : 'Classification Result'}</h4>
                            <pre>${result.answer}</pre>
                        </div>
                    `;
                    container.insertBefore(card, container.firstChild);
                } else {
                    const errorCard = Components.createErrorCard('classify', result.error);
                    container.insertBefore(errorCard, container.firstChild);
                }
            } catch (e) {
                document.getElementById('loading-classify')?.remove();
                const errorCard = Components.createErrorCard('classify', e.message);
                container.insertBefore(errorCard, container.firstChild);
            }
            
            btn.disabled = false;
            btn.textContent = 'ğŸ” å¼€å§‹åˆ†ç±»';
        }

        // æ¸…ç©ºç»“æœ
        function clearResults() {
            testResults = [];
            document.getElementById('resultsContainer').innerHTML = '';
        }

        // åŠ è½½é¢„è®¾å›¾ç‰‡
        function loadPresetImages() {
            const images = [
                { id: '1', name: 'hot_pink', path: '../../data/2å›¾ç‰‡åˆ†ç±»/data/1-hot_pink.jpg' },
                { id: '10', name: 'ç®±é¾Ÿ', path: '../../data/2å›¾ç‰‡åˆ†ç±»/data/10-ç®±é¾Ÿ.jpg' },
                { id: '13', name: 'è€ƒæ‹‰', path: '../../data/2å›¾ç‰‡åˆ†ç±»/data/13-è€ƒæ‹‰1.jpg' },
                { id: '17', name: 'é‡‘æ¯›å¯»å›çŠ¬', path: '../../data/2å›¾ç‰‡åˆ†ç±»/data/17-é‡‘æ¯›å¯»å›çŠ¬_ç®€å•.jpg' }
            ];
            
            const grid = document.getElementById('imageGrid');
            grid.innerHTML = '<p style="color: var(--text-muted);">é¢„è®¾å›¾ç‰‡åŠŸèƒ½å¼€å‘ä¸­...</p>';
        }

        // åŠ è½½é…ç½®
        function loadConfig() {
            const config = API.loadConfig();
            if (config) {
                document.getElementById('apiBaseUrl').value = config.base_url || '';
                document.getElementById('apiKey').value = config.api_key || '';
            }
        }

        // åˆå§‹åŒ–
        loadConfig();
        loadPresetImages();
        updatePromptsForLanguage(); // åˆå§‹åŒ–æç¤ºè¯
    </script>
</body>
</html>
